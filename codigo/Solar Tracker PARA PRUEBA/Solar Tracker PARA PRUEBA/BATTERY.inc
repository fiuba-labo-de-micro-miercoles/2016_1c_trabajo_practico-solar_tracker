;-------------------------------------------------------------------------
;
;							BATTERY.inc
;
;-------------------------------------------------------------------------
.CSEG

BATTERY_INIT:
	INPUT AUX,DDRD
	ANDI AUX,(~((1<<DDD4)|(1<<DDD7)))	;Mascara para tocar solo D3
	ORI AUX,((1<<DDD4)|(1<<DDD7))
	OUTPUT DDRD,AUX
	RCALL INDICATE_BATTERY_LOW

	;INICIALIZO LA INFORMACION DE LA TENSION PARA TRANSMITIR POR BLUETOOTH
	LDIW X,V_BATTERY_DATA
	STI	X+,'0'
	STI	X+,'0'
	STI	X+,'.'
	STI	X+,'0'
	STI	X+,'V'
	STI X+,'\r'
	STI X+,'\n'
	STI	X,0

RET

READ_V_BATTERY:
		LDI ADC_DATA_L,ADC_BATTERY			;ELIJO EL PIN DE LA BATERÍA
		RCALL ADC_SELECT_INPUT				;LLAMO LA FUNCION PARA SELECCIONAR LA BATERIA
		RCALL ADC_SIMPLE_CONVERSION			;LLAMO LA FUNCION PARA MEDIR
RET

CHECK_IF_BATTERY_MINIMUM:
	CLC
	CPI		ADC_DATA_H,MIN_BATTERY_VALUE	;COMPARAR PARA VER SI HAY SUFICIENTE BATERIA PARA OPERAR
	BRCS	_INDICATE_BATTERY_LOW						;[CARRY=1]: BATTERY LOW. [CARRY=0]: BATTERY OK
	RCALL INDICATE_BATTERY_OK
	
RETURN_INDICATE_BATTERY_LOW:
RET

_INDICATE_BATTERY_LOW:
	RCALL INDICATE_BATTERY_LOW
	SEC										;[CARRY=1]: BATTERY LOW. [CARRY=0]: BATTERY OK
RJMP RETURN_INDICATE_BATTERY_LOW

INDICATE_BATTERY_LOW:
	INPUT	AUX,PORTD
	ANDI	AUX,(~((1<<PIN_BATTERY_LED_OK)|(1<<PIN_BATTERY_LED_LOW)))
	ORI		AUX,((1<<PIN_BATTERY_LED_OK)|(0<<PIN_BATTERY_LED_LOW))		;PRENDE POR CERO.
	OUTPUT	PORTD,AUX
RET

INDICATE_BATTERY_OK:
	INPUT	AUX,PORTD
	ANDI	AUX,(~((1<<PIN_BATTERY_LED_OK)|(1<<PIN_BATTERY_LED_LOW)))
	ORI		AUX,((0<<PIN_BATTERY_LED_OK)|(1<<PIN_BATTERY_LED_LOW))		;PRENDE POR CERO.
	OUTPUT	PORTD,AUX
	CLC										;[CARRY=1]: BATTERY LOW. [CARRY=0]: BATTERY OK
RET