/*
*	LIGHT.inc [COMO SI FUERA UN OBJETO]
*
*  Created: 01/06/2016 13:10:11 p.m.
*   Author: MAU
*/ 
.CSEG
;FUTURA MEJORA: HACER QUE LA LUZ SE MUEVA POR PWM EN FUNCION DE LA CARGA DE LA BATERIA
LIGHT_INIT:
;CONFIGURO COMO SALIDA LIGHT_PIN
	INPUT	AUX,DDRD
	ANDI	AUX,(~(1<<LIGHT_PIN))
	ORI		AUX,(1<<LIGHT_PIN)

	RCALL	LIGHT_TURN_OFF
RET

LIGHT_TURN_ON:
	INPUT AUX,BT_FLAG
	CPI AUX,0xFF						;[FLAG=0xFF]: ESTA CONECTADO A BT. NO MODIFICAR EL ESTADO
	BREQ ORDEN_BT_NO_HACER_NADA			;[FLAG=0x00]: NO ESTA CONECTADO A BT.

	LDI AUX,100
	RCALL READ_V_BATTERY
	CPI	ADC_DATA_H,230
	BRSH EXC_CHARGE
	CPI	ADC_DATA_H,170
	BRSH GOOD_CHARGE
	CPI	ADC_DATA_H,150
	BRSH BAD_CHARGE
EXC_CHARGE:
	ADDI AUX,50
GOOD_CHARGE:
	ADDI AUX,50
BAD_CHARGE:
	ADDI AUX,55
	OUTPUT OCR2B,AUX

ORDEN_BT_NO_HACER_NADA:
RET

LIGHT_TURN_OFF:
	INPUT AUX,BT_FLAG
	CPI AUX,0xFF						;[FLAG=0xFF]: ESTA CONECTADO A BT. 
	BREQ ORDEN_BT_NO_HACER_NADA			;[FLAG=0x00]: NO ESTA CONECTADO A BT.

	CLR AUX
	OUTPUT OCR2B,AUX
RET